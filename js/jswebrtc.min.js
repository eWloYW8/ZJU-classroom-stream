var JSWebrtc={Player:null,VideoElement:null,CreateVideoElements:function(){for(var t=document.querySelectorAll(".jswebrtc"),e=0;e<t.length;e++)new JSWebrtc.VideoElement(t[e])},FillQuery:function(t,e){if(e.user_query={},0!=t.length){t.indexOf("?")>=0&&(t=t.split("?")[1]);for(var o=t.split("&"),i=0;i<o.length;i++){var n=o[i].split("=");e[n[0]]=n[1],e.user_query[n[0]]=n[1]}e.domain&&(e.vhost=e.domain)}},ParseUrl:function(t){var e=document.createElement("a");e.href=t.replace("rtmp://","http://").replace("webrtc://",window.location.protocol+"//").replace("rtc://",window.location.protocol+"//");var o=e.hostname,i=e.pathname.substr(1,e.pathname.lastIndexOf("/")-1),n=e.pathname.substr(e.pathname.lastIndexOf("/")+1);if((i=i.replace("...vhost...","?vhost=")).indexOf("?")>=0){var s=i.substr(i.indexOf("?"));i=i.substr(0,i.indexOf("?")),s.indexOf("vhost=")>0&&(o=s.substr(s.indexOf("vhost=")+6)).indexOf("&")>0&&(o=o.substr(0,o.indexOf("&")))}e.hostname==o&&/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/.test(e.hostname)&&(o="__defaultVhost__");var a="rtmp";t.indexOf("://")>0&&(a=t.substr(0,t.indexOf("://")));var r=e.port;r||("http"===a?r=80:"https"===a?r=443:"rtmp"===a?r=1935:"webrtc"!==a&&"rtc"!==a||(r=0==window.location.protocol.search("https")?443:1985)),0==window.location.protocol.search("https")&&(t=t.replace("http://","https://"));var p={url:t,schema:a,server:e.hostname,port:r,vhost:o,app:i,stream:n};return JSWebrtc.FillQuery(e.search,p),p},HttpPost:function(t,e){return new Promise((function(o,i){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState&&n.status>=200&&n.status<300){var t=JSON.parse(n.responseText);n.onreadystatechange=new Function,n=null,o(t)}},n.open("POST",t,!0),n.responseType="text",n.setRequestHeader("Content-Type","application/json"),n.send(e)}))}};"complete"===document.readyState?JSWebrtc.CreateVideoElements():document.addEventListener("DOMContentLoaded",JSWebrtc.CreateVideoElements),JSWebrtc.VideoElement=function(){"use strict";var t=function(e){var o=e.dataset.url;if(!o)throw"VideoElement has no `data-url` attribute";var i=function(t,e){for(var o in e)t.style[o]=e[o]};this.container=e,i(this.container,{display:"inline-block",position:"relative",minWidth:"80px",minHeight:"80px"}),this.video=document.createElement("video"),this.video.width=960,this.video.height=540,i(this.video,{display:"block",width:"100%"}),this.container.appendChild(this.video),this.playButton=document.createElement("div"),this.playButton.innerHTML=t.PLAY_BUTTON,i(this.playButton,{zIndex:2,position:"absolute",top:"0",bottom:"0",left:"0",right:"0",maxWidth:"75px",maxHeight:"75px",margin:"auto",opacity:"0.7",cursor:"pointer"}),this.container.appendChild(this.playButton);var n={video:this.video};for(var s in e.dataset)try{n[s]=JSON.parse(e.dataset[s])}catch(t){n[s]=e.dataset[s]}if(this.player=new JSWebrtc.Player(o,n),e.playerInstance=this.player,n.poster&&!n.autoplay&&(n.decodeFirstFrame=!1,this.poster=new Image,this.poster.src=n.poster,this.poster.addEventListener("load",this.posterLoaded),i(this.poster,{display:"block",zIndex:1,position:"absolute",top:0,left:0,bottom:0,right:0}),this.container.appendChild(this.poster)),this.player.options.streaming||this.container.addEventListener("click",this.onClick.bind(this)),n.autoplay&&(this.playButton.style.display="none"),this.player.audioOut&&!this.player.audioOut.unlocked){var a=this.container;n.autoplay&&(this.unmuteButton=document.createElement("div"),this.unmuteButton.innerHTML=t.UNMUTE_BUTTON,i(this.unmuteButton,{zIndex:2,position:"absolute",bottom:"10px",right:"20px",width:"75px",height:"75px",margin:"auto",opacity:"0.7",cursor:"pointer"}),this.container.appendChild(this.unmuteButton),a=this.unmuteButton),this.unlockAudioBound=this.onUnlockAudio.bind(this,a),a.addEventListener("touchstart",this.unlockAudioBound,!1),a.addEventListener("click",this.unlockAudioBound,!0)}};return t.prototype.onUnlockAudio=function(t,e){this.unmuteButton&&(e.preventDefault(),e.stopPropagation()),this.player.audioOut.unlock(function(){this.unmuteButton&&(this.unmuteButton.style.display="none"),t.removeEventListener("touchstart",this.unlockAudioBound),t.removeEventListener("click",this.unlockAudioBound)}.bind(this))},t.prototype.onClick=function(t){this.player.isPlaying?(this.player.pause(),this.playButton.style.display="block"):(this.player.play(),this.playButton.style.display="none",this.poster&&(this.poster.style.display="none"))},t.PLAY_BUTTON='<svg style="max-width: 75px; max-height: 75px;" viewBox="0 0 200 200" alt="Play video"><circle cx="100" cy="100" r="90" fill="none" stroke-width="15" stroke="#fff"/><polygon points="70, 55 70, 145 145, 100" fill="#fff"/></svg>',t.UNMUTE_BUTTON='<svg style="max-width: 75px; max-height: 75px;" viewBox="0 0 75 75"><polygon class="audio-speaker" stroke="none" fill="#fff" points="39,13 22,28 6,28 6,47 21,47 39,62 39,13"/><g stroke="#fff" stroke-width="5"><path d="M 49,50 69,26"/><path d="M 69,50 49,26"/></g></svg>',t}(),JSWebrtc.Player=function(){"use strict";var t=function(t,e){if(this.options=e||{},!this.options.video)throw"VideoElement is null";this.proxy=this.options.proxy||"https://mcloudpush.cmc.zju.edu.cn:10443/player",this.urlParams=JSWebrtc.ParseUrl(t),this.pc=null,this.autoplay=!!e.autoplay||!1,this.paused=!0,this.startLoading()};return t.prototype.startLoading=function(){var t=this;t.pc&&t.pc.close(),t.pc=new RTCPeerConnection(null),t.pc.addEventListener("connectionstatechange",(()=>{console.log(`pull status ${t.pc.connectionState}`),"failed"===t.pc.connectionState&&t.startLoading()})),t.pc.ontrack=function(e){t.options.video.srcObject=e.streams[0],console.log(e.streams[0].getVideoTracks()[0])},t.pc.addTransceiver("audio",{direction:"recvonly"}),t.pc.addTransceiver("video",{direction:"recvonly"}),t.pc.createOffer().then((function(e){return t.pc.setLocalDescription(e).then((function(){return e}))})).then((function(e){return new Promise((function(o,i){console.log(t.urlParams.url);var n={url:t.urlParams.url,clientip:null,sdp:e.sdp};console.log("--------------------",t.proxy),JSWebrtc.HttpPost(t.proxy,JSON.stringify(n)).then((function(t){o(t.sdp)}),(function(t){i(t)}))}))})).then((function(e){return console.log(e),t.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e}))})).catch((function(t){throw console.log("throw reason error:",t),t})),this.autoplay&&this.play()},t.prototype.play=function(t){this.animationId||(this.animationId=requestAnimationFrame(this.update.bind(this)),this.paused=!1)},t.prototype.pause=function(t){this.paused||(cancelAnimationFrame(this.animationId),this.animationId=null,this.isPlaying=!1,this.paused=!0,this.options.video.pause(),this.options.onPause&&this.options.onPause(this))},t.prototype.stop=function(t){this.pause(),console.log("当前pc",this.pc)},t.prototype.destroy=function(){this.pc&&this.pc.close()&&this.pc.destroy(),this.pc=null,this.audioOut&&this.audioOut.destroy()},t.prototype.changeVideo=function(t){this.options.video=t,console.log("切换后的video",this.options),this.pc.ontrack=function(t){this.options.video.srcObject=t.streams[0]},this.play()},t.prototype.update=function(){this.animationId=requestAnimationFrame(this.update.bind(this)),this.options.video.readyState<4||this.isPlaying||(this.isPlaying=!0,this.options.video.play().then().catch((t=>{console.error(t),this.options.onError&&this.options.onError(this,t)})),this.options.onPlay&&this.options.onPlay(this))},t}();